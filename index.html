<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skrittkonkurranse Familie</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chrono-node/1.3.11/chrono.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .chart-container { margin: 40px 0; }
    .text-2xl { font-size: 1.5rem; }
    .text-xl { font-size: 1.25rem; }
    .download-btn { margin-top: 10px; }
    .error { color: red; }
    .guide { background-color: #f9fafb; padding: 15px; border-radius: 8px; margin-top: 10px; }
    .guide ul { margin-left: 20px; }
    .table-container { margin: 40px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Initialiserer React og Recharts-komponenter
    const { createRoot } = ReactDOM;
    const { PieChart, Pie, Cell, Legend, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid, ResponsiveContainer } = Recharts;

    // Definerer hovedkomponenten App
    const App = () => {
      const [data, setData] = React.useState(null);
      const [error, setError] = React.useState(null);

      // Behandler og renser data
      const processAndCleanData = (rawData) => {
        if (!rawData || rawData.length === 0) {
          throw new Error("CSV-filen er tom eller ugyldig.");
        }

        const requiredHeaders = ["Navn", "Hvilken team tilhører du?", "Dato for skritttallene", "Hvor mange skritt gikk du?"];
        const headers = Object.keys(rawData[0]);
        if (!requiredHeaders.every(header => headers.includes(header))) {
          throw new Error("CSV-filen mangler nødvendige kolonner: " + requiredHeaders.join(", "));
        }

        const cleanedData = rawData.filter(row => 
          row["Navn"] && 
          row["Hvilken team tilhører du?"] && 
          row["Dato for skritttallene"] && 
          row["Hvor mange skritt gikk du?"] && 
          !isNaN(parseFloat(row["Hvor mange skritt gikk du?"]))
        );

        if (cleanedData.length === 0) {
          throw new Error("Ingen gyldige data etter rensing.");
        }

        // Fjerner duplikater ved å beholde siste oppføring for hver person-dato-team-kombinasjon
        const uniqueEntries = {};
        cleanedData.forEach(row => {
          const key = `${row["Navn"]}-${row["Dato for skritttallene"]}-${row["Hvilken team tilhører du?"]}`;
          uniqueEntries[key] = {
            name: row["Navn"],
            team: row["Hvilken team tilhører du?"],
            date: chrono.parseDate(row["Dato for skritttallene"]),
            steps: parseFloat(row["Hvor mange skritt gikk du?"].replace(/,/g, '')) || 0
          };
        });

        // Finner konkurranseperioden (første til siste registrerte dag)
        const dates = Object.values(uniqueEntries).map(entry => entry.date);
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        const competitionDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1; // Inkluderer begge ender
        const formatDate = (date) => date.toLocaleDateString('no-NO', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const periodInfo = {
          from: formatDate(minDate),
          to: formatDate(maxDate),
          days: competitionDays
        };

        // Aggregerer skritt per team og teller unike medlemmer
        const teamSteps = {};
        const teamMembers = {};
        Object.values(uniqueEntries).forEach(row => {
          teamSteps[row.team] = (teamSteps[row.team] || 0) + row.steps;
          teamMembers[row.team] = teamMembers[row.team] || new Set();
          teamMembers[row.team].add(row.name);
        });
        const teamData = Object.entries(teamSteps).map(([team, steps]) => ({
          name: team,
          value: Math.round(steps / (teamMembers[team].size * competitionDays)) // Gjennomsnitt per medlem per dag
        }));

        // Aggregerer skritt per person for topp 5 og total oversikt
        const personSteps = {};
        const personDays = {};
        const personTeams = {};
        Object.values(uniqueEntries).forEach(row => {
          personSteps[row.name] = (personSteps[row.name] || 0) + row.steps;
          personDays[row.name] = personDays[row.name] || new Set();
          personDays[row.name].add(row.date.toISOString().split('T')[0]);
          personTeams[row.name] = row.team; // Antatt at hver person tilhører ett team
        });
        const top5Persons = Object.entries(personSteps)
          .map(([name, steps]) => ({
            name: `${name} (${personTeams[name]})`,
            totalSteps: steps,
            avgSteps: Math.round(steps / personDays[name].size)
          }))
          .sort((a, b) => b.totalSteps - a.totalSteps)
          .slice(0, 5);

        const allPersons = Object.entries(personSteps)
          .map(([name, steps]) => ({
            name,
            team: personTeams[name],
            totalSteps: steps
          }))
          .sort((a, b) => b.totalSteps - a.totalSteps);

        const topPerson = allPersons[0]?.name || "Ingen data";
        const teams = Object.keys(teamSteps);

        return { teamData, top5Persons, allPersons, topPerson, teams, periodInfo };
      };

      // Håndterer filopplasting
      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.endsWith('.csv')) {
          setError('Vennligst last opp en CSV-fil.');
          setData(null);
          return;
        }

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          transformHeader: header => header.trim().replace(/^"|"$/g, ''),
          transform: (value, header) => value.trim().replace(/^"|"$/g, ''),
          complete: (results) => {
            try {
              const cleanedData = processAndCleanData(results.data);
              setData(cleanedData);
              setError(null);
            } catch (err) {
              setError(err.message);
              setData(null);
            }
          },
          error: (err) => {
            setError('Feil ved parsing av CSV: ' + err.message);
            setData(null);
          }
        });
      };

      // Formaterer store tall for visning
      const formatNumber = (num) => {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
        return num.toString();
      };

      // Eksporterer diagram som bilde
      const downloadChart = (id, filename) => {
        const element = document.getElementById(id);
        html2canvas(element).then(canvas => {
          const link = document.createElement('a');
          link.download = filename;
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      };

      // Definerer farger for diagrammene
      const COLORS = ['#0088FE', '#00C49F', '#FFBB28'];

      return (
        <div className="container">
          {/* Viser overskrift og opplastingsfelt med guide */}
          <h1 className="text-2xl font-bold mb-4">Skrittkonkurranse Familie</h1>
          <div className="mb-4">
            <label className="block text-lg mb-2">Last opp CSV-fil fra Slack-listen:</label>
            <input
              type="file"
              accept=".csv"
              onChange={handleFileUpload}
              className="border p-2 rounded"
            />
            <div className="guide">
              <h3 className="text-lg font-semibold mb-2">Guide for å laste ned CSV-fil fra Slack</h3>
             <ol className="list-decimal list-inside">
                <li>Åpne <strong>Skrittkonkurranse</strong>-fanen i <strong>#familie</strong> kanalen (denne vises som en tabb øverst).</li>
                <li>Klikk på <strong>"tre prikker"</strong>-knappen øverst til høyre på siden listen vises.</li>
                <li>Velg <strong>"Last ned CSV" / "Download CSV"</strong> fra menyen for å laste ned filen.</li>
                <li>Trykk på velg fil knappen og velg filen du akkurat lastet ned</li>
                <li><div className="inline-flex">Magic happens <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 -52 1128 1128" class="icon" version="1.1"><path d="M473.184 356.632c-23.048-28.336-64.616-32.632-92.816-9.672-28.248 23.048-32.568 64.528-9.616 92.84l473.328 547.152c22.928 28.248 64.376 32.488 92.776 9.552 28.224-22.992 32.512-64.528 9.528-92.752l-473.2-547.12z" fill="#0092D2"/><path d="M151.4 65.976l-1.056-0.472 54.912 223.104L52.68 460.32l229.128 16.664 116.12 198.2 56.8-139.376 389.6 450.344c22.224 27.4 61.792 31.984 90.072 11.32L151.4 65.976z" fill="#0085BF"/><path d="M150.104 66.304L360.56 158.4 555.752 37.224l-22.52 228.6L708.8 414.016l-224.416 49.24-86.664 212.728-116.152-198.2-229.12-16.672 152.6-171.712z" fill="#F5B146"/><path d="M276.192 225.08l95.368 41.712 88.424-54.888-10.2 103.576 79.568 67.144-101.704 22.312-39.28 96.368-52.616-89.816-103.808-7.52 69.144-77.816z" fill="#E5226B"/><path d="M484.384 463.256l0.528-0.112L152.072 67.152l-1.208-0.528 54.856 222.92-152.48 171.624 228.328 16.616 0.064 0.08 0.648 0.064 115.68 197.464z" fill="#EF962F"/><path d="M434.56 403.408L289.6 230.928l-13.408-5.848 24.896 101.072-69.144 77.816 103.808 7.52 52.616 89.816 39.28-96.368z" fill="#C9005B"/></svg></div> </li>
                <li>Nå ser du en fin oversikt over resultatet :)</li>
              </ol>
            </div>
          </div>
          {error && <p className="error text-lg mb-4">{error}</p>}

          {/* Viser rapport hvis data er tilgjengelig */}
          {data && (
            <>
              <p className="mb-4">
                <strong>Sammendrag:</strong> Denne rapporten analyserer data fra skrittkonkurransen for følgende team: {data.teams.join(", ")}. 
                Personen med flest skritt er {data.topPerson}. Konkurranseperioden går fra {data.periodInfo.from} til {data.periodInfo.to} ({data.periodInfo.days} dager). 
                Rapporten viser gjennomsnittlig antall skritt per team per dag over denne perioden, de fem mest aktive personene, og en oversikt over totale skritt per person.
              </p>

              {/* Viser kakediagram for gjennomsnittlig skritt per team */}
              <div className="chart-container" id="pie-chart">
                <h2 className="text-xl font-semibold mb-2">Gjennomsnittlig antall skritt per team per dag</h2>
                <ResponsiveContainer width="100%" height={400}>
                  <PieChart>
                    <Pie
                      data={data.teamData}
                      dataKey="value"
                      nameKey="name"
                      cx="50%"
                      cy="50%"
                      outerRadius={150}
                      label={({ value }) => formatNumber(value)}
                    >
                      {data.teamData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip formatter={(value) => formatNumber(value)} />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
                <button
                  className="download-btn bg-blue-500 text-white px-4 py-2 rounded"
                  onClick={() => downloadChart('pie-chart', 'gjennomsnitt_skritt_per_team.png')}
                >
                  Last ned som bilde
                </button>
              </div>

              {/* Viser stolpediagram for topp 5 personer */}
              <div className="chart-container" id="bar-chart">
                <h2 className="text-xl font-semibold mb-2">Topp 5 personer etter totalt antall skritt</h2>
                <ResponsiveContainer width="100%" height={400}>
                  <BarChart data={data.top5Persons} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" fontSize={12} />
                    <YAxis yAxisId="left" fontSize={12} tickFormatter={formatNumber} />
                    <YAxis yAxisId="right" orientation="right" fontSize={12} tickFormatter={formatNumber} />
                    <Tooltip formatter={(value) => formatNumber(value)} />
                    <Bar yAxisId="left" dataKey="totalSteps" fill="#0088FE" name="Totalt skritt" />
                    <Bar yAxisId="right" dataKey="avgSteps" fill="#00C49F" name="Gjennomsnittlig skritt per dag" />
                  </BarChart>
                </ResponsiveContainer>
                <button
                  className="download-btn bg-blue-500 text-white px-4 py-2 rounded"
                  onClick={() => downloadChart('bar-chart', 'topp_5_personer_skritt.png')}
                >
                  Last ned som bilde
                </button>
              </div>

              {/* Viser tabell med totale skritt per person */}
              <div className="table-container">
                <h2 className="text-xl font-semibold mb-2">Totalt antall skritt per person</h2>
                <table>
                  <thead>
                    <tr>
                      <th>Navn</th>
                      <th>Team</th>
                      <th>Totalt skritt</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.allPersons.map((person, index) => (
                      <tr key={index}>
                        <td>{person.name}</td>
                        <td>{person.team}</td>
                        <td>{formatNumber(person.totalSteps)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Viser konklusjon */}
              <div>
                <h2 className="text-xl font-semibold mb-2">Konklusjon</h2>
                <p>
                  Rapporten viser gjennomsnittlig skritttall per team per dag over konkurranseperioden ({data.periodInfo.from} til {data.periodInfo.to}, {data.periodInfo.days} dager), de mest aktive personene, og en oversikt over totale skritt per person. 
                  {data.topPerson} leder konkurransen med flest skritt. Noen team har høye gjennomsnitt på grunn av svært aktive medlemmer, mens topp 5-personene viser variasjon i både totalt og gjennomsnittlig daglig antall skritt. 
                  Økt deltakelse fra mindre aktive team kan bidra til en jevnere konkurranse.
                </p>
              </div>
            </>
          )}
        </div>
      );
    };

    // Rendrer appen
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>